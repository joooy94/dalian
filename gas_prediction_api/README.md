# å¤©ç„¶æ°”é¢„æµ‹APIæœåŠ¡ ğŸš€

åŸºäºå†å²3å‘¨åŒæœŸæ•°æ®çš„å¤©ç„¶æ°”æµé‡å’Œå‹åŠ›é¢„æµ‹æœåŠ¡ï¼Œä½¿ç”¨Holt-WintersæŒ‡æ•°å¹³æ»‘ç®—æ³•å’ŒFastAPIæ¡†æ¶æ„å»ºã€‚

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬é¡¹ç›®æä¾›å¤©ç„¶æ°”æµé‡å’Œå‹åŠ›çš„é¢„æµ‹æœåŠ¡ï¼Œé€šè¿‡åˆ†æå†å²3å‘¨åŒæœŸæ•°æ®ï¼Œä½¿ç”¨Holt-WintersæŒ‡æ•°å¹³æ»‘æ¨¡å‹è¿›è¡Œæ—¶é—´åºåˆ—é¢„æµ‹ã€‚APIæœåŠ¡æ”¯æŒRESTfulæ¥å£ï¼Œæä¾›æµé‡é¢„æµ‹ã€å‹åŠ›é¢„æµ‹å’Œå¯è§†åŒ–æµ‹è¯•åŠŸèƒ½ã€‚

### æ ¸å¿ƒç‰¹æ€§

- ğŸ”® **æ™ºèƒ½é¢„æµ‹**ï¼šåŸºäºHolt-WintersæŒ‡æ•°å¹³æ»‘ç®—æ³•çš„æ—¶é—´åºåˆ—é¢„æµ‹
- ğŸ“Š **å¤šæŒ‡æ ‡æ”¯æŒ**ï¼šåŒæ—¶æ”¯æŒå¤©ç„¶æ°”æµé‡å’Œå‹åŠ›é¢„æµ‹
- ğŸ•’ **é«˜ç²¾åº¦æ—¶é—´åºåˆ—**ï¼š1åˆ†é’Ÿçº§åˆ«çš„é¢„æµ‹ç²¾åº¦
- ğŸ“ˆ **å¯è§†åŒ–æµ‹è¯•**ï¼šæä¾›é¢„æµ‹ç»“æœå¯¹æ¯”å›¾è¡¨
- ğŸš€ **é«˜æ€§èƒ½API**ï¼šåŸºäºFastAPIçš„å¼‚æ­¥RESTfulæœåŠ¡
- ğŸ”§ **æ™ºèƒ½ä¿®æ­£**ï¼šè‡ªåŠ¨åå·®æ ¡æ­£å’Œæå€¼å¤„ç†

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
å¤©ç„¶æ°”é¢„æµ‹APIæœåŠ¡
â”œâ”€â”€ æ•°æ®è·å–å±‚ (API Data Fetcher)
â”‚   â”œâ”€â”€ å†å²æ•°æ®è·å– (3å‘¨åŒæœŸæ•°æ®)
â”‚   â””â”€â”€ æ•°æ®éªŒè¯å’Œæ¸…æ´—
â”œâ”€â”€ æ•°æ®å¤„ç†å±‚ (Data Processing)
â”‚   â”œâ”€â”€ é«˜æ–¯æ»¤æ³¢å¹³æ»‘
â”‚   â”œâ”€â”€ æ—¶é—´åºåˆ—å¯¹é½
â”‚   â””â”€â”€ è®­ç»ƒæ•°æ®æ„å»º
â”œâ”€â”€ é¢„æµ‹æ¨¡å‹å±‚ (Prediction Models)
â”‚   â”œâ”€â”€ Holt-WintersæŒ‡æ•°å¹³æ»‘
â”‚   â”œâ”€â”€ å­£èŠ‚æ€§æ¨¡å¼è¯†åˆ«
â”‚   â””â”€â”€ æ™ºèƒ½é¢„æµ‹ä¿®æ­£
â”œâ”€â”€ APIæœåŠ¡å±‚ (FastAPI Server)
â”‚   â”œâ”€â”€ æµé‡é¢„æµ‹æ¥å£ (/predict)
â”‚   â”œâ”€â”€ å‹åŠ›é¢„æµ‹æ¥å£ (/predict_pressure)
â”‚   â”œâ”€â”€ æµ‹è¯•å¯è§†åŒ–æ¥å£ (/test)
â”‚   â””â”€â”€ é™æ€æ–‡ä»¶æœåŠ¡ (/static)
â””â”€â”€ å¯è§†åŒ–å±‚ (Visualization)
    â”œâ”€â”€ å†å²æ•°æ®å¯¹æ¯”å›¾
    â””â”€â”€ é¢„æµ‹ç»“æœå±•ç¤º
```

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

- **Python 3.8+**ï¼šæ ¸å¿ƒç¼–ç¨‹è¯­è¨€
- **FastAPI**ï¼šç°ä»£å¼‚æ­¥Webæ¡†æ¶
- **Pandas**ï¼šæ•°æ®å¤„ç†å’Œåˆ†æ
- **NumPy**ï¼šæ•°å€¼è®¡ç®—
- **SciPy**ï¼šç§‘å­¦è®¡ç®—ï¼ˆé«˜æ–¯æ»¤æ³¢ï¼‰
- **Statsmodels**ï¼šç»Ÿè®¡å»ºæ¨¡ï¼ˆHolt-Wintersï¼‰
- **Matplotlib**ï¼šæ•°æ®å¯è§†åŒ–
- **Pydantic**ï¼šæ•°æ®éªŒè¯å’Œåºåˆ—åŒ–
- **Uvicorn**ï¼šASGIæœåŠ¡å™¨

## ğŸ“¦ å®‰è£…ä¸é…ç½®

### ç¯å¢ƒè¦æ±‚

- Python 3.8+
- pip æˆ– conda åŒ…ç®¡ç†å™¨

### å®‰è£…ä¾èµ–

```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>
cd dalian

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### é…ç½®æ•°æ®æº

ç¡®ä¿ `stl_decomposition/api_data_fetcher.py` æ–‡ä»¶æ­£ç¡®é…ç½®äº†æ•°æ®æºAPIæ¥å£ã€‚

## ğŸš€ å¿«é€Ÿå¯åŠ¨

### å¯åŠ¨æœåŠ¡å™¨

```bash
python api_gas_prediction_server.py
```

æœåŠ¡å™¨å°†åœ¨ `http://127.0.0.1:58888` å¯åŠ¨ã€‚

### éªŒè¯æœåŠ¡

è®¿é—®ä»¥ä¸‹URLéªŒè¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œï¼š

- **æœåŠ¡ä¿¡æ¯**ï¼šhttp://127.0.0.1:58888/
- **å¥åº·æ£€æŸ¥**ï¼šhttp://127.0.0.1:58888/health
- **APIæ–‡æ¡£**ï¼šhttp://127.0.0.1:58888/docs

## ğŸ“– APIæ¥å£æ–‡æ¡£

### 1. æµé‡é¢„æµ‹æ¥å£

**ç«¯ç‚¹**ï¼š`GET /predict`

**æè¿°**ï¼šé¢„æµ‹æŒ‡å®šæ—¥æœŸçš„å¤©ç„¶æ°”æµé‡

**å‚æ•°**ï¼š
- `date` (å¿…éœ€)ï¼šé¢„æµ‹æ—¥æœŸï¼Œæ ¼å¼ä¸º `YYYY-MM-DD`

**ç¤ºä¾‹è¯·æ±‚**ï¼š
```bash
curl "http://127.0.0.1:58888/predict?date=2025-07-07"
```

**å“åº”æ ¼å¼**ï¼š
```json
{
    "success": true,
    "prediction_date": "2025-07-07",
    "metric": "ç¬æ—¶æµé‡",
    "data_points": 1440,
    "predictions": [
        {
            "timestamp": "2025-07-07T00:00:00",
            "forecast": 123.45
        },
        {
            "timestamp": "2025-07-07T00:01:00",
            "forecast": 124.56
        }
        // ... 1440ä¸ªæ•°æ®ç‚¹ (æ¯åˆ†é’Ÿä¸€ä¸ª)
    ]
}
```

### 2. å‹åŠ›é¢„æµ‹æ¥å£

**ç«¯ç‚¹**ï¼š`GET /predict_pressure`

**æè¿°**ï¼šé¢„æµ‹æŒ‡å®šæ—¥æœŸçš„å¤©ç„¶æ°”å‹åŠ›

**å‚æ•°**ï¼š
- `date` (å¿…éœ€)ï¼šé¢„æµ‹æ—¥æœŸï¼Œæ ¼å¼ä¸º `YYYY-MM-DD`

**ç¤ºä¾‹è¯·æ±‚**ï¼š
```bash
curl "http://127.0.0.1:58888/predict_pressure?date=2025-07-07"
```

**å“åº”æ ¼å¼**ï¼š
```json
{
    "success": true,
    "prediction_date": "2025-07-07",
    "metric": "æ€»å‹åŠ›",
    "data_points": 1440,
    "predictions": [
        {
            "timestamp": "2025-07-07T00:00:00",
            "forecast": 0.85
        },
        {
            "timestamp": "2025-07-07T00:01:00",
            "forecast": 0.86
        }
        // ... 1440ä¸ªæ•°æ®ç‚¹
    ]
}
```

### 3. æµ‹è¯•é¢„æµ‹æ¥å£

**ç«¯ç‚¹**ï¼š`GET /test`

**æè¿°**ï¼šç”Ÿæˆé¢„æµ‹ç»“æœå¹¶è¿”å›å¯è§†åŒ–å›¾è¡¨

**å‚æ•°**ï¼š
- `date` (å¿…éœ€)ï¼šé¢„æµ‹æ—¥æœŸï¼Œæ ¼å¼ä¸º `YYYY-MM-DD`
- `metric` (å¯é€‰)ï¼šé¢„æµ‹æŒ‡æ ‡ï¼Œå¯é€‰å€¼ä¸º `flow`ï¼ˆæµé‡ï¼‰æˆ– `pressure`ï¼ˆå‹åŠ›ï¼‰ï¼Œé»˜è®¤ä¸º `flow`

**ç¤ºä¾‹è¯·æ±‚**ï¼š
```bash
# æµ‹è¯•æµé‡é¢„æµ‹
curl "http://127.0.0.1:58888/test?date=2025-07-07&metric=flow"

# æµ‹è¯•å‹åŠ›é¢„æµ‹
curl "http://127.0.0.1:58888/test?date=2025-07-07&metric=pressure"
```

**å“åº”æ ¼å¼**ï¼š
```json
{
    "success": true,
    "prediction_date": "2025-07-07",
    "metric": "ç¬æ—¶æµé‡",
    "plot_file": "test_flow_prediction_20250707.png",
    "message": "é¢„æµ‹å®Œæˆï¼Œå…±ç”Ÿæˆ1440ä¸ªæ•°æ®ç‚¹ã€‚å¯é€šè¿‡ /static/test_flow_prediction_20250707.png æŸ¥çœ‹é¢„æµ‹å›¾è¡¨ã€‚"
}
```

**æŸ¥çœ‹å›¾è¡¨**ï¼š
```
http://127.0.0.1:58888/static/test_flow_prediction_20250707.png
```

### 4. é™æ€æ–‡ä»¶æœåŠ¡

**ç«¯ç‚¹**ï¼š`GET /static/{filename}`

**æè¿°**ï¼šè®¿é—®ç”Ÿæˆçš„å›¾ç‰‡æ–‡ä»¶

**ç¤ºä¾‹**ï¼š
```
http://127.0.0.1:58888/static/test_flow_prediction_20250707.png
```

### 5. å¥åº·æ£€æŸ¥æ¥å£

**ç«¯ç‚¹**ï¼š`GET /health`

**æè¿°**ï¼šæ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€

**å“åº”æ ¼å¼**ï¼š
```json
{
    "status": "healthy",
    "service": "å¤©ç„¶æ°”é¢„æµ‹API",
    "version": "1.0.0"
}
```

### 6. æœåŠ¡ä¿¡æ¯æ¥å£

**ç«¯ç‚¹**ï¼š`GET /`

**æè¿°**ï¼šè·å–æœåŠ¡åŸºæœ¬ä¿¡æ¯å’Œå¯ç”¨ç«¯ç‚¹

**å“åº”æ ¼å¼**ï¼š
```json
{
    "service": "å¤©ç„¶æ°”é¢„æµ‹APIæœåŠ¡",
    "version": "1.0.0",
    "endpoints": {
        "flow_prediction": "/predict?date=YYYY-MM-DD",
        "pressure_prediction": "/predict_pressure?date=YYYY-MM-DD",
        "test_prediction": "/test?date=YYYY-MM-DD&metric=flow/pressure",
        "static_files": "/static/{filename}",
        "health_check": "/health"
    },
    "description": "åŸºäºå†å²3å‘¨åŒæœŸæ•°æ®çš„å¤©ç„¶æ°”æµé‡å’Œå‹åŠ›é¢„æµ‹æœåŠ¡"
}
```

## ğŸ”¬ é¢„æµ‹ç®—æ³•è¯´æ˜

### æ•°æ®è·å–ç­–ç•¥

1. **å†å²æ•°æ®é€‰æ‹©**ï¼šè·å–é¢„æµ‹æ—¥æœŸå‰3å‘¨åŒä¸€æ˜ŸæœŸå‡ çš„æ•°æ®
   - 3å‘¨å‰åŒä¸€å¤©ï¼ˆå¦‚ï¼šé¢„æµ‹å‘¨ä¸€ï¼Œè·å–3å‘¨å‰çš„å‘¨ä¸€ï¼‰
   - 2å‘¨å‰åŒä¸€å¤©
   - 1å‘¨å‰åŒä¸€å¤©

2. **æ•°æ®éªŒè¯**ï¼šç¡®ä¿æ¯å¤©è‡³å°‘æœ‰1000ä¸ªæ•°æ®ç‚¹ï¼ˆçº¦17å°æ—¶çš„æ•°æ®ï¼‰

### æ•°æ®å¤„ç†æµç¨‹

1. **æ•°æ®å¹³æ»‘**ï¼šä½¿ç”¨é«˜æ–¯æ»¤æ³¢ï¼ˆÏƒ=3ï¼‰å‡å°‘å™ªå£°
2. **æ—¶é—´å¯¹é½**ï¼šå°†3å‘¨æ•°æ®æŒ‰æ—¶é—´é¡ºåºè¿æ¥æˆè®­ç»ƒåºåˆ—
3. **è´¨é‡æ£€æŸ¥**ï¼šå¤„ç†ç¼ºå¤±å€¼å’Œå¼‚å¸¸å€¼

### Holt-Wintersé¢„æµ‹æ¨¡å‹

1. **æ¨¡å‹é…ç½®**ï¼š
   - å­£èŠ‚æ€§å‘¨æœŸï¼š1440åˆ†é’Ÿï¼ˆ1å¤©ï¼‰
   - å­£èŠ‚æ€§ç±»å‹ï¼šåŠ æ³•å­£èŠ‚æ€§
   - è¶‹åŠ¿ï¼šæ— è¶‹åŠ¿ï¼ˆæ›´ç¨³å®šï¼‰

2. **æ™ºèƒ½ä¿®æ­£**ï¼š
   - **åå·®æ ¡æ­£**ï¼šæ£€æµ‹é¢„æµ‹å‡å€¼åå·®å¹¶è‡ªåŠ¨æ ¡æ­£
   - **è´Ÿå€¼å¤„ç†**ï¼šå°†è´Ÿå€¼æ›¿æ¢ä¸ºåˆç†æœ€å°å€¼
   - **æå€¼é™åˆ¶**ï¼šé™åˆ¶é¢„æµ‹å€¼åœ¨å†å²æ•°æ®åˆç†èŒƒå›´å†…
   - **å¹³æ»‘å¤„ç†**ï¼šè½»åº¦æ»‘åŠ¨çª—å£å¹³æ»‘

## ğŸ“Š ä½¿ç”¨ç¤ºä¾‹

### Pythonå®¢æˆ·ç«¯ç¤ºä¾‹

```python
import requests
import json
import pandas as pd

# è·å–æµé‡é¢„æµ‹
response = requests.get('http://127.0.0.1:58888/predict?date=2025-07-07')
data = response.json()

if data['success']:
    # è½¬æ¢ä¸ºDataFrame
    df = pd.DataFrame(data['predictions'])
    df['timestamp'] = pd.to_datetime(df['timestamp'])
    
    print(f"é¢„æµ‹æ—¥æœŸ: {data['prediction_date']}")
    print(f"æ•°æ®ç‚¹æ•°: {data['data_points']}")
    print(f"é¢„æµ‹èŒƒå›´: {df['forecast'].min():.2f} ~ {df['forecast'].max():.2f}")
    print(f"é¢„æµ‹å‡å€¼: {df['forecast'].mean():.2f}")

# è·å–æµ‹è¯•å›¾è¡¨
test_response = requests.get('http://127.0.0.1:58888/test?date=2025-07-07&metric=flow')
test_data = test_response.json()

if test_data['success']:
    print(f"å¯è§†åŒ–å›¾è¡¨: http://127.0.0.1:58888/static/{test_data['plot_file']}")
```

### JavaScriptå®¢æˆ·ç«¯ç¤ºä¾‹

```javascript
// è·å–æµé‡é¢„æµ‹
async function getFlowPrediction(date) {
    try {
        const response = await fetch(`http://127.0.0.1:58888/predict?date=${date}`);
        const data = await response.json();
        
        if (data.success) {
            console.log(`é¢„æµ‹æ—¥æœŸ: ${data.prediction_date}`);
            console.log(`æ•°æ®ç‚¹æ•°: ${data.data_points}`);
            console.log('é¢„æµ‹æ•°æ®:', data.predictions);
            return data.predictions;
        }
    } catch (error) {
        console.error('é¢„æµ‹è¯·æ±‚å¤±è´¥:', error);
    }
}

// ä½¿ç”¨ç¤ºä¾‹
getFlowPrediction('2025-07-07');
```

## ğŸ”§ é…ç½®è¯´æ˜

### æœåŠ¡å™¨é…ç½®

åœ¨ `api_gas_prediction_server.py` æ–‡ä»¶æœ«å°¾å¯ä»¥ä¿®æ”¹æœåŠ¡å™¨é…ç½®ï¼š

```python
# ä¿®æ”¹ç›‘å¬åœ°å€å’Œç«¯å£
uvicorn.run(app, host='0.0.0.0', port=8000)
```

### é¢„æµ‹å‚æ•°è°ƒä¼˜

å¯ä»¥åœ¨ `APIGasPredictor` ç±»ä¸­è°ƒæ•´ä»¥ä¸‹å‚æ•°ï¼š

- **é«˜æ–¯æ»¤æ³¢å‚æ•°**ï¼š`sigma=3`ï¼ˆæ•°æ®å¹³æ»‘ç¨‹åº¦ï¼‰
- **å­£èŠ‚æ€§å‘¨æœŸ**ï¼š`seasonal_periods=1440`ï¼ˆåˆ†é’Ÿï¼‰
- **åå·®æ ¡æ­£é˜ˆå€¼**ï¼š`data_std * 0.12`
- **æå€¼é™åˆ¶å€æ•°**ï¼š`data_max * 1.15`, `data_min * 0.85`

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ•°æ®è·å–å¤±è´¥**
   - æ£€æŸ¥ `api_data_fetcher.py` ä¸­çš„APIé…ç½®
   - ç¡®è®¤ç½‘ç»œè¿æ¥å’ŒAPIæœåŠ¡å¯ç”¨æ€§

2. **é¢„æµ‹ç²¾åº¦ä¸ç†æƒ³**
   - å¢åŠ å†å²æ•°æ®å‘¨æ•°
   - è°ƒæ•´é«˜æ–¯æ»¤æ³¢å‚æ•°
   - ä¿®æ”¹Holt-Wintersæ¨¡å‹å‚æ•°

3. **æœåŠ¡å¯åŠ¨å¤±è´¥**
   - æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
   - éªŒè¯æ‰€æœ‰ä¾èµ–åŒ…æ˜¯å¦æ­£ç¡®å®‰è£…

### æ—¥å¿—è°ƒè¯•

æœåŠ¡è¿è¡Œæ—¶ä¼šè¾“å‡ºè¯¦ç»†æ—¥å¿—ï¼ŒåŒ…æ‹¬ï¼š
- æ•°æ®è·å–è¿‡ç¨‹
- é¢„æµ‹æ¨¡å‹è®­ç»ƒ
- ä¿®æ­£ç®—æ³•æ‰§è¡Œ
- APIè¯·æ±‚å¤„ç†